%% read data
singleCycle_force = -[
    -27.49388886
    -31.86770312
    -36.23477139
    -40.8184901
    -45.39132204
    -50.07688276
    -54.79098891
    -59.52648385
    -64.29798542
    -69.02385379
    -73.75400349
    -78.41339854
    -83.01618567
    -87.53508907
    -91.94133525
    -96.2381879
    -100.3847228
    -104.3834598
    -108.2061415
    -111.8410203
    -115.2761229
    -118.4906936
    -121.4795311
    -124.2237543
    -126.7166535
    -128.9467798
    -130.9042497
    -132.5836866
    -133.975979
    -135.0779104
    -135.8840163
    -136.3919251
    -136.6004367
    -136.5083949
    -136.1173461
    -135.429067
    -134.4472944
    -133.1763352
    -131.6219544
    -129.79107
    -127.6915263
    -125.3325903
    -122.7241187
    -119.8771604
    -116.8034723
    -113.5159166
    -110.0281037
    -106.3541021
    -102.5089189
    -98.50802777
    -94.36762936
    -90.10407233
    -85.734346
    -81.27566817
    -76.74552829
    -72.16182606
    -67.54201687
    -62.90450242
    -58.26673388
    -53.6468159
    zeros(40,1)];

knee_angle_raw = -[-55.11708732
-55.83900513
-56.52659017
-57.16529849
-57.5553304
-57.64780507
-57.62290076
-57.46447088
-57.03545389
-56.37020575
-55.5312311
-54.54092095
-53.37804356
-52.08246027
-50.49297837
-48.75949255
-46.83789327
-44.79025972
-42.62554235
-40.26833597
-37.74408198
-35.02976386
-32.19107148
-29.3045595
-26.62352572
-23.61252756
-20.46697171
-17.71309078
-14.99400006
-12.43848796
-10.26085306
-8.26794504
-6.52375514
-5.08146035
-3.78282582
-2.59774255
-1.63136419
-0.67316896
0.09511863
0.72267437
1.1791555
1.51070599
1.71412363
1.84458205
1.87115816
1.77415211
1.64090204
1.48793449
1.24780398
1.25254728
1.10863472
1.00836551
0.86875266
0.69771459
0.44015136
0.06416885
-0.37678639
-0.9868944
-1.69015535
-2.44436233
-3.30892648
-4.23996198
-5.33605614
-6.69961096
-8.23910708
-10.10215924
-12.23727849
-14.68837064
-17.56157844
-21.05738049
-24.86166375
-28.86123496
-32.97699046
-37.12842069
-41.11277299
-44.46253196
-47.46014026
-50.52729576
-53.50320669
-56.17166343
-58.40477998
-60.34667414
-61.95848209
-63.20712356
-64.29755671
-65.17219749
-65.85691902
-66.38729425
-66.66161085
-66.81533339
-66.7851778
-66.5987148
-66.36450211
-66.02545015
-65.64383258
-65.15371438
-64.64377
-64.01476213
-63.42676519
-62.7819917
-62.04732968
-61.2319344
-60.31942644
-59.46603995
-58.57118871
-57.72729564
-56.95484269
-56.41702545
-56.06234091
-55.92511485
-55.91658145
-55.96396413
-56.06794523
-56.29840052
-56.54180733
-56.39852024
-56.20116992
-55.83285624
-55.54126184
-55.423839
-55.11823618
-54.52289281
-53.752822
-52.79122184
-51.62200024
-50.3245498
-48.92851726
-47.45624977
-45.93108489
-44.17055065
-42.30854172
-40.39717994
-38.36574691
-36.19888286
-33.71418606
-31.41376105
-28.72454311
-26.01689056
-22.98998982
-20.10141635
-17.19487618
-14.51592871
-12.02273302
-9.88254013
-8.09706816
-6.50376698
-5.22427682
-3.94898055
-2.86062162
-1.92926989
-1.12812068
-0.35813502
0.16184974
0.62464556
0.90534484
1.09140371
1.28000016
1.3767356
1.43341273
1.42402759
1.43128821
1.47852237
1.38560537
1.23911605
1.12648339
0.77260918
0.41880025
-0.02534094
-0.62788614
-1.33841905
-2.14581009
-3.1506361
-4.30952943
-5.71378535
-7.34850963
-9.16970142
-11.32238377
-13.85199527
-16.81449157
-20.22650182
-24.01461804
-27.86060591
-31.96298311
-36.13967046
-40.32550835
-44.38991009
-48.0590912
-51.06396567
-54.17849665
-57.23110487
-59.97307945
-62.23037437
-64.10135705
-65.65376039
-66.80135059
-67.73988738
-68.33818852
-68.73480207
-68.88662305
-68.83869009
-68.58932909
-68.13926869
-67.57037899
-66.82926152
-65.9719437
-64.97920068
-63.95151557
-62.79935937
-61.72328375
-60.54875988
-59.38071228
-58.22219988
-57.13411229
-56.13232732
-55.24860398
-54.49853781
-53.85649989
-53.35951625
-53.08279104
-53.02863993
-52.85861071
-53.12892371
-53.3876932
-53.97003977
-54.84120835
-55.55750456
-56.20423452
-56.43988468
-56.36339444
-56.22901693
-55.97554071
-55.65874319
-55.0433063
-54.37449664
-53.57836522
-52.58016165
-51.41607145
-50.1152513
-48.6480458
-47.06913815
-45.31166284
-43.5610791
-41.55700299
-39.55890842
-37.45931111
-35.13479038
-32.7609787
-30.13847485
-27.49299518
-24.39153319
-21.54037548
-18.76108373
-15.87508617
-13.19132285
-10.84457646
-8.84274134
-7.03166483
-5.44321441
-4.10500652
-2.82956722
-1.61593748
-0.58558763
0.30434017
1.02564563
1.68233607
2.11479505
2.46560961
2.65572073
2.70851769
2.68563969
2.52675179
2.32773554
2.06796885
1.73918755
1.37523324
1.05446705
0.54065842
0.24840468
-0.24302833
-0.75014235
-1.41828424
-2.16909563
-3.11285729
-4.23609896
-5.6586622
-7.38672296
-9.52453174
-12.30307424
-15.67132061
-19.62454476
-24.02625055
-28.47042439
-32.99044808
-37.62287135
-42.20392767
-46.49040132
-50.08948375
-53.17769605
-56.40159544
-59.26016826
-61.79880493
-63.79375256
-65.46307637
-66.77950812
-67.70862028
-68.37695509
-68.78226787
-68.89371317
-68.81361009
-68.42737501
-67.8509363
-67.09570226
-66.21174439
-65.20003194
-64.08279987
-62.8813376
-61.69668628
-60.54544805
-59.32039668
-58.16063175
-56.96523376
-56.02474555
-55.03964369
-54.17241313
-53.33859549
-52.61539045
-52.07615249
-51.63629268
-51.2397655
-51.18589395
-51.10167653
-51.32234972
-51.51766471
-51.71524797
-52.34647777
-53.24519576
];

%% calculate exo force
% 26~31 sec
% 1st gait cycle: 26.714 s (1122) ~ 27.847 s (2255)
% 2nd gait cycle: 27.848 s (2256) ~ 28.947 s (3355)
% 3rd gait cycle: 28.948 s (3356) ~ 30.057 s (4465)

exo_force_1 = interp1(1:100, singleCycle_force, linspace(1,100,2255-1122+1), "linear");
exo_force_2 = interp1(1:100, singleCycle_force, linspace(1,100,3355-2256+1), "linear");
exo_force_3 = interp1(1:100, singleCycle_force, linspace(1,100,4465-3356+1), "linear");

exo_force = [exo_force_1 exo_force_2 exo_force_3];

knee_angle = interp1(1:length(knee_angle_raw), knee_angle_raw, linspace(1, length(knee_angle_raw), length(exo_force)), "linear");

% 大腿受力点距膝关节：0.2 m
b = 0.2;
% 小腿受力点距膝关节：0.2 m
c = 0.2;
% 大小腿夹角(钝角，强制保持≤179°）
A = deg2rad(180-knee_angle);
A(A>(deg2rad(179))) = deg2rad(179);
% 实时推杆长度（余弦定理）
a = sqrt(b^2 + c^2 - 2*b*c*cos(A));
% 推杆与大腿夹角（锐角∠ABC，正弦定理）
B = asin(sin(A)*b./a);
% 推杆与小腿夹角（锐角∠ACB，正弦定理）
C = asin(sin(A)*c./a);

femur_fx = (exo_force .* sin(B))';
femur_fy = (exo_force .* cos(B))';
tibia_fx = (exo_force .* sin(C))';
tibia_fy = (-exo_force .* cos(C))';

figure, plot(femur_fx, 'LineWidth', 2); hold on
plot(femur_fy), plot(tibia_fx), plot(tibia_fy)
legend('femur fx', 'femur fy', 'tibia fx', 'tibia fy');